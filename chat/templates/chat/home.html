{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}
Feeds
{% endblock %}

{% block content %}
<div class="row">
	<div class="col-md-8 col-sm-12">
		<h1 class="py-3 px-2 bg-dark text-light d-flex justify-content-between">
			News Feed
			<a href="{% url 'chat:add_post' %}">
				<i class="fas fa-plus text-light"></i>
			</a>
		</h1>

		<!-- Search Bar -->
		<div class="my-3">
			<input type="text" id="searchBar" class="form-control" placeholder="Search posts...">
		</div>

		<div class="container bg-grey" id="postsContainer">
			{% for post in posts %}
			<div class="my-4 card" style="box-shadow: #484646 0px 4px 1px" data-post-id="{{ post.id }}">
				{% if post.picture %}
				<div class="card-img-top text-center">
					<img style="max-width: 99%; height: auto;" src="{{ post.picture.url }}">
				</div>
				{% endif %}
				<div class="card-body">
					<div class="card-title text-right">
						{% if post.user == request.user %}
						<strong>Me</strong>
						{% else %}
						<strong>
							<a class='text-dark' href="{% url 'accounts:view-profile' post.user.username %}">
								{{ post.user.first_name }} {{ post.user.last_name }}
							</a>
						</strong>
						{% endif %}
					</div>
					<div class="card-text">
						{{ post.text }}
					</div>
				</div>
				<div class="card-footer">
					<div class="d-flex justify-content-between">
						<i>{{ post.posted_date }}</i>
						{% if post.user == request.user %}
						<a class="btn btn-outline-dark" data-toggle='collapse' href="#comments{{ post.id }}"
							role="button" aria-expanded="false" aria-controls="comments{{ post.id }}">
							<i class="fas fa-2x fa-comment"></i> <span class="badge badge-danger"></span>
						</a>
						{% endif %}

						<a href="{% url 'chat:delete_post' post.id %}" class="btn btn-outline-danger"
							onclick="return confirm('Are you sure you want to delete this post?')">
							<i class="fas fa-trash"></i> Delete
						</a>
					</div>
					<div class="collapse" id="comments{{ post.id }}">
						<div class="mt-2 card card-body">
							{% for comment in post.comments.all %}
							<code class="blockquote text-center border-bottom" style="font-size: 0.8rem">
                                {{ comment.text }}
                                <footer class="blockquote-footer">
                                    {% if comment.user == user %}
                                        Me
                                    {% else %}
                                        {{ comment.user.first_name }} {{ comment.user.last_name }}
                                    {% endif %}
                                    {{ comment.comment_date }}
                                </footer>
                            </code>
							{% endfor %}
							<form method="POST" enctype="multipart/form-data">
								{% csrf_token %}
								{% for field in form %}
								<div class="form-group">
									{% if field.errors %}
									<div class="alert alert-warning alert-dismissible fade show" role='alert'>
										{{ field.errors }}
										<button type="button" class="close" data-dismiss="alert" aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
									{% endif %}
									{{ field.label_tag }}
									{{ field|add_class:'form-control' }}
									{% if field.field.required %}
									<small class="form-text text-muted">This field is required.</small>
									{% endif %}
								</div>
								{% endfor %}
								<input type="submit" value="Submit" class="btn btn-primary btn-block">
							</form>

						</div>
					</div>
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
	<div class="col-md-4">
		<h3 class="py-3 px-2 bg-dark text-light text-right">Me</h3>
		{% include 'accounts/profile.html' %}
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const searchBar = document.getElementById('searchBar');
		const postsContainer = document.getElementById('postsContainer');

		searchBar.addEventListener('input', function () {
			const query = searchBar.value.toLowerCase();
			console.log('Search query:', query);  // Debugging log

			document.querySelectorAll('#postsContainer .card').forEach(function (card) {
				const text = card.querySelector('.card-text').textContent.toLowerCase();
				console.log('Post text:', text);  // Debugging log
				if (text.includes(query)) {
					card.style.display = '';  // Show post
				} else {
					card.style.display = 'none';  // Hide post
				}
			});
		});
	});
</script>
{% endblock %}